<template>
	<view>
		<uni-forms ref="roomTypeRef" :modelValue="roomTypeForm" :rules="roomTypeRules" label-width="90px">
			<uni-forms-item label="房型名称" required name="name">
				<uni-easyinput v-model="roomTypeForm.name" placeholder="请输入房型名称" :disabled="type==2" />
			</uni-forms-item>
			<!-- <uni-forms-item label="房间数量" name="count">
                <view>
                    <uv-number-box :min="1" integer v-model="roomTypeForm.count" :disabled="type==2">
                        <input slot="input" style="width: 100px;text-align: center;" class="input"
                            v-model="roomTypeForm.count"></input>
                    </uv-number-box>
                </view>
            </uni-forms-item> -->
			<uni-forms-item label="面积" name="area">
				<view style="display:flex;align-items:center">
					<uv-number-box :min="1" integer v-model="roomTypeForm.area" :disabled="type==2">
						<input slot="input" style="width: 100px;text-align: center;" class="input"
							v-model="roomTypeForm.area"></input>
					</uv-number-box><text style="padding-left:8px">㎡</text>
				</view>
			</uni-forms-item>
			<uni-forms-item label="入住人数" name="count">
				<view>
					<uv-number-box :min="1" integer v-model="roomTypeForm.guestNumber" :disabled="type==2">
						<input slot="input" style="width: 100px;text-align: center;" class="input"
							v-model="roomTypeForm.guestNumber"></input>
					</uv-number-box>
				</view>
			</uni-forms-item>
			<uni-forms-item label="床位" required>
				<!-- <uni-data-checkbox v-model="orderForm.roomTypeArray" mode="list"  multiple :localdata="roomTypeListFormat">1111</uni-data-checkbox> -->
				<view class="uni-list">
					<checkbox-group @change="bedCheckboxChange">
						<view :class="[this.type==2? 'disabled-style':'']" style="display: flex"
							v-for="(item, index) in bedTypeList" :key="item.name">
							<view>
								<checkbox :checked="item.checked" :disabled="type==2" :value="item.name" />
							</view>
							<view style="display: flex; flex: 1">{{item.name}}</view>
							<view><uni-number-box v-model="item.count" :min="1" :disabled="!item.checked||type==2" />
							</view>
						</view>
					</checkbox-group>
				</view>
			</uni-forms-item>
			<uni-forms-item label="价格" required>
				<view class="group">

					<uv-number-box :min="0" integer v-model="roomTypeForm.priceBase" :disabled="type==2"
						inputWidth="60px">
						<input slot="input" style="width: 200px;text-align: center;"
							v-model="roomTypeForm.priceBase"></input>
					</uv-number-box>
				</view>
			</uni-forms-item>
			<!-- <uni-forms-item label="是否有窗" name="isWindow">

				 <view style="display:flex;align-items:center;height:100%"> 
				  <radio-group @change="radioEvent('isWindow')">
					<radio value="1" :checked="roomTypeForm.isWindow" /><text style="padding-right:10px">是</text>
					<radio value="0" :checked="!roomTypeForm.isWindow" /><text style="padding-right:10px">否</text>
				  </radio-group>
				 </view>				
			  </uni-forms-item> -->
			<!-- <uni-forms-item label="有阳台" name="isBalcony">
				 <view style="display:flex;align-items:center;height:100%"> 
				  <radio-group @change="radioEvent('isBalcony')">
					<radio value="1" :checked="roomTypeForm.isBalcony" :disabled="type==2"/><text style="padding-right:10px">是</text>
					<radio value="0" :checked="!roomTypeForm.isBalcony" :disabled="type==2"/><text style="padding-right:10px">否</text>
				  </radio-group>
				 </view>				
			  </uni-forms-item>
			  <uni-forms-item label="有浴缸" name="isBathtub">
				 <view style="display:flex;align-items:center;height:100%"> 
				  <radio-group @change="radioEvent('isBathtub')">
					<radio value="1" :checked="roomTypeForm.isBathtub" :disabled="type==2"/><text style="padding-right:10px">是</text>
					<radio value="0" :checked="!roomTypeForm.isBathtub" :disabled="type==2"/><text style="padding-right:10px" >否</text>
				  </radio-group>
				 </view>				
			  </uni-forms-item>
			<uni-forms-item label="洗漱用品" name="isOffer">
				 <view style="display:flex;align-items:center;height:100%"> 
				  <radio-group @change="radioEvent('disposableToiletries')">
					<radio value="1" :checked="roomTypeForm.disposableToiletries" :disabled="type==2"/><text style="padding-right:10px">是</text>
					<radio value="0" :checked="!roomTypeForm.disposableToiletries" :disabled="type==2"/><text style="padding-right:10px">否</text>
				  </radio-group>
				 </view>				
			  </uni-forms-item> -->
			<!-- <view style="display:flex;flex-direction:column;gap:10px;font-size:13px;padding-bottom:15px">
				<view>价格设置</view>
				<view class="priceContainer">
					<view class="price-list">
						<view class="price-list-item">
							<view class="group">
								<text>名称：</text>
								<input placeholder="基本价格" v-model="roomTypeForm.priceBase_name" class="in"
									type="textarea" :disabled="type==2"></input>
							</view>
							<view class="group">
								<text>价格：</text>
								<uv-number-box :min="0" integer v-model="roomTypeForm.priceBase" :disabled="type==2"
									inputWidth="60px">
									<input slot="input" style="width: 200px;text-align: center;"
										v-model="roomTypeForm.priceBase"></input>
								</uv-number-box>
							</view>

						</view>
					</view>
				</view>

				<view class="priceContainer">
					<view class="price-list">
						<view class="price-list-item">
							<view class="group">
								<text>名称：</text>
								<input placeholder="套餐A" v-model="roomTypeForm.priceA_name" class="in" type="textarea"
									:disabled="type==2"></input>
							</view>
							<view class="group">
								<text>价格：</text>
								<uv-number-box :min="0" integer v-model="roomTypeForm.priceA" :disabled="type==2"
									inputWidth="60px">
									<input slot="input" style="width: 200px;text-align: center;"
										v-model="roomTypeForm.priceA"></input>
								</uv-number-box>
							</view>

						</view>
					</view>
				</view>
				<view class="priceContainer">
					<view class="price-list">
						<view class="price-list-item">
							<view class="group">
								<text>名称：</text>
								<input placeholder="套餐B" v-model="roomTypeForm.priceB_name" class="in" type="textarea"
									:disabled="type==2"></input>
							</view>
							<view class="group">
								<text>价格：</text>
								<uv-number-box :min="0" integer v-model="roomTypeForm.priceB" :disabled="type==2"
									inputWidth="60px">
									<input slot="input" style="width: 200px;text-align: center;"
										v-model="roomTypeForm.priceB"></input>
								</uv-number-box>
							</view>

						</view>
					</view>
				</view>
				<view><text style="color:#a1a1a1;color:#0765ae">单个房型最多可设置3个价格，分别为基本价格，套餐价格，如 带早餐价格，与基本价格区分.<text
							style="color:#ff0000">如要取消套餐，将价格设置为0</text></text></view>



			</view> -->
			<!-- <uni-forms-item label="标准价格" required>
			<view style="display:flex;justify-content:space-between"> 
				<view class="group flex-center">
					<text>名称：</text> 
					<input placeholder="基本价格" v-model="roomTypeForm.priceBase_name"  class="in" :disabled="type==2"></input> 
				</view>
				<view class="group flex-center">
					<text>价格：</text> 
					<uv-number-box :min="0" integer v-model="roomTypeForm.priceBase" :disabled="type==2" inputWidth="60px">
						<input slot="input" style="width: 200px;text-align: center;" 
							v-model="roomTypeForm.priceBase"></input>
					</uv-number-box>
				</view>
			</view>
			
		</uni-forms-item>  -->
			<!-- <uni-forms-item label="是否议价"> 
				<radio-group @change="isBargainChange" >
					<radio :disabled="type==2" :value="true" :checked="roomTypeForm.isBargain" /><text style="padding-right:10px">是</text>
					<radio :disabled="type==2" :value="false" :checked="!roomTypeForm.isBargain" /><text style="padding-right:10px">否</text>
				  </radio-group>
			  </uni-forms-item>
			  <uni-forms-item label="议价范围" v-if="roomTypeForm.isBargain"> 
		
				  <view class="flex-center">
					<view style="flex:1"><slider :disabled="type==2" :value="roomTypeForm.bargainMinPercent" @change="bargainMinPercentChange" min="50" max="100" show-value /> </view><text>（最低{{roomTypeForm.bargainMinPercent}}%）</text>
				</view>				
			  </uni-forms-item> -->



			<uni-forms-item label="屋内设施" required>
				<checkbox-group @change="facilityCheckboxChange">
					<unicloud-db v-slot:default="{data, loading, error, options}" collection="hm-facilityConfig"
						field="name" :getone="false" where="type=='roomType'" orderby="name asc">

						<view :class="[this.type==2? 'disabled-style':'', 'flex-center']"
							style="justify-content:start;flex-wrap:wrap; gap:20px">
							<view style="" v-for="(item, index) in data" :key="item.name">
								<checkbox :checked="roomTypeForm.facility&&roomTypeForm.facility.includes(item._id)"
									:disabled="type==2" :value="item._id" />{{item.name}}
							</view>
							<view style="height:0;width:50px" v-for="item in 5">
							</view>
						</view>
					</unicloud-db>
				</checkbox-group>
			</uni-forms-item>
			<view>
				<uni-forms-item label="封面图片" style="margin-bottom:0"></uni-forms-item>
				<xt-file-picker ref="uploadImagesRef1" :cloudPath="cloudPath" @success="uploadSuccessFirst"
					:imagesList="roomTypeForm.firstImages? [roomTypeForm.firstImages]:[]" max="1"
					:disabled="type==2"></xt-file-picker>
				<uni-forms-item label="房型图片" style="margin-bottom:0"></uni-forms-item>
				<xt-file-picker ref="uploadImagesRef2" :cloudPath="cloudPath" @success="uploadSuccess"
					:imagesList="roomTypeForm.imagesList" :disabled="type==2"></xt-file-picker>

			</view>
			<view class="room-area">
				<view class="flex-between header">
					<view>房间（{{roomTypeForm.roomList.length}}）</view>
					<!-- <navigator :url="`/pages/hotelManage/createRoom/createRoom`" v-if="this.type!=2">
						 -->
						<view class="btn" @click="addRoomEvent">

							<view class="flex-center"><l-icon name="solar:add-circle-bold" size="22px"
									color="#007aff" /></view>
							<view class="flex-center"><text>添加房间</text></view>


						</view>
					<!-- </navigator> -->
				</view>
				<view v-if="!roomTypeForm.roomList.length" class="note"><text>无房间</text></view>
				<uni-list v-if="roomTypeForm.roomList.length">
					<uni-list-item  v-for="(item,index) of roomTypeForm.roomList">
						<template v-slot:header> 
							<view style="width:200px"> 
								<uni-easyinput v-model="item.room_name" trim="all"  @input="changeRoomName(index)" :disabled="type==2" :clean="false"/>
							</view>
						</template>
						<template v-slot:footer>
							<view @click="deleteRoomEvent(index)">
								<l-icon name="iconamoon:trash" size="22px" color="#007aff"></l-icon>
							</view>
						</template>
					</uni-list-item>
					
				</uni-list>
			</view>
			<view class="submit-btn-style">
				<uv-button type="success" text="保存" color="#007aff" @click="submitForm()" :disabled="submitDisabled"
					:loading="submitLoading" v-if="type!=2" class="submit-btn"></uv-button>
					
			</view>
		</uni-forms>

	</view>
</template>

<script>
import  {DB} from "../../../api/DB.js";
import XtFilePicker from '../../../components/xt-file-picker/xt-file-picker.vue';
import LIcon from '../../../uni_modules/lime-icon/components/l-icon/l-icon.vue';
import uniFormsItem from '../../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.vue';
import UniListItem from '../../../uni_modules/uni-list/components/uni-list-item/uni-list-item.vue';
import UniSection from '../../../uni_modules/uni-section/components/uni-section/uni-section.vue';
import { colorGradient } from '@/uni_modules/uv-ui-tools/libs/function/colorGradient.js';
export default {
  components: { uniFormsItem, XtFilePicker, UniSection, UniListItem, LIcon },
		props:{
			type:0,
			rt:{}
		},
		data() {
			return {
				submitLoading: false,
				cloudPath:`/${this.$store.state.hotel_id}/roomType/`,
				roomTypeForm: this.type!=0?{
                    "count": this.rt.count,
                    "name": this.rt.name,
					"area":this.rt.area,
					//"isBathtub":this.rt.isBathtub,
					//"isBalcony":this.rt.isBalcony,
					"isWindow":this.rt.isWindow,
					"guestNumber":this.rt.guestNumber,
					"firstImages":this.rt.firstImages||"",
					"imagesList": this.rt.imagesList||[],
					//"disposableToiletries":this.rt.disposableToiletries,
					"bedList":this.rt.bedList,
                    "roomList":this.rt.roomList,
					"facility":this.rt.facility||[],
					"priceBase_name":this.rt.priceBase_name,
					"priceA_name":this.rt.priceA_name,
					"priceB_name":this.rt.priceB_name,
					"priceBase":this.rt.priceBase,
					"priceA":this.rt.priceA,
					"priceB":this.rt.priceB,
					isBargain:this.rt.isBargain,
					bargainMinPercent:this.rt.bargainMinPercent||80
				}: {
                    "count": 1,
                    "name": "",
					"area":15,
					"isWindow":true,
					//"isBathtub":false,
					//"isBalcony":true,
					"guestNumber":2,
					"firstImages":"",
					"imagesList":[],
					//"disposableToiletries":true,
					"bedList":[],
                    "roomList":[],
					"facility":[],
					"priceBase_name":"",
					"priceA_name":"",
					"priceB_name":"",
					"priceBase":0,
					"priceA":0,
					"priceB":0,
					isBargain:true,
					bargainMinPercent:80
                
				},
				bedTypeList:[
					{name:"1.8米",checked:false,count:1},
					{name:"1.5米",checked:false,count:1},
					{name:"1.3米",checked:false,count:1},
					{name:"1.2米",checked:false,count:1}
				],
				roomTypeRules: {
					// 对name字段进行必填验证
					name: {
						rules: [{
								required: true,
								errorMessage: '请输入房型名称',
							},
							{
								validateFunction: (rule, value,data,callback)=> {									
									let obj = this.roomType.find(item=>{ return item.name==value});
									if(this.type==1){
										 obj = this.roomType.find(item=>{ return item.name==value && item._id !=this.rt._id});
									}
									if(obj){
										callback('已存在相同房型名称')
									}
									return true;
								}
							}
						],
					},
					bedList:[{
								required: true,
								errorMessage: '请选择床位',
							}]
				}


			};
		},
		created() {
			
		},
		mounted(){
			console.log(this.rt);
			//床位赋值
			if(this.roomTypeForm.bedList&&this.roomTypeForm.bedList.length){
				for(let i=0;i<this.bedTypeList.length;i++){
					let obj = this.roomTypeForm.bedList.find(it=>it.name ==this.bedTypeList[i].name );
					if(obj){
						this.bedTypeList[i].checked=true;
						this.bedTypeList[i].count=obj.count;
					}
				}
			}
		},
		computed: {
			hotel_id(){
				return this.$store.state.hotel_id;
			},
			hotelList(){
				return this.$store.state.hotelList;
			},
            roomType() {
				return this.$store.state.roomType;
			}, 
			bedTypeListFomat(){
				let arr = this.bedTypeList.filter(item=>item.checked);
				return arr.map(item=>{
					return {name:item.name,count:item.count};
				})
			},
			validRoomList(){
				const arr = this.roomTypeForm.roomList;
				let obj = arr.find(item=>item.room_name=="");
				return obj?true:false;
			},         
			submitDisabled() {
				return false
			}
		},
		methods: {
			bargainMinPercentChange(e){
				this.roomTypeForm.bargainMinPercent=e.detail.value
			},
			isBargainChange(e){
      			let {value} = e.detail;
      			this.roomTypeForm.isBargain = value;
   				 },
			facilityCheckboxChange(e){
				this.roomTypeForm.facility = e.detail.value;
			},
			bedCheckboxChange(e){
			console.log(e)
			for(let i =0;i<this.bedTypeList.length;i++){
				this.bedTypeList[i].checked=e.detail.value.includes(this.bedTypeList[i].name)
			}			
			},
			radioEvent(key){
				this.roomTypeForm[key]=!this.roomTypeForm[key];
			},
			// isWindowEvent(){
			// 	this.roomTypeForm.isWindow=!this.roomTypeForm.isWindow;
			// },
			// isDisposableToiletries(){
			// 	this.roomTypeForm.disposableToiletries=!this.roomTypeForm.disposableToiletries;
			// },
			uploadSuccessFirst(list){
				this.roomTypeForm.firstImages=list[0];
			},
			uploadSuccess(list){
				console.log("list");
				this.roomTypeForm.imagesList=list;
			},
            roomTypeCountChange(val){
                console.log(val)
            },
			changeRoomName(e,index){
				console.log(arguments)
			},
			submitForm() {
				if(this.$refs.uploadImagesRef1.uploadingState()==0||this.$refs.uploadImagesRef2.uploadingState()==0){
					uni.showToast({title:"有图片正在上传中，请稍候...",icon:"error"});
					return;
				}
				if(this.$refs.uploadImagesRef1.uploadingState()==2||this.$refs.uploadImagesRef2.uploadingState()==2){
					uni.showToast({title:"有图片上传失败，请重新上传或取消",icon:"error"});
					return;
				}
				if(this.bedTypeListFomat.length<1){
					uni.showToast({title:"请选择床位",icon:"none"});
					return;
				}
				if(!this.validRoomList){
					uni.showToast({title:"房间名不能为空",icon:"none"});
					return;
				}
				this.roomTypeForm.hotel_id=this.hotel_id;
				this.roomTypeForm.bedList=this.bedTypeListFomat;
				this.$refs.roomTypeRef.validate().then(res => {
					//uni.showLoading();
					this.submitLoading = true;
            
					if(this.type==1){
						this.updateRoomType();
						return ;
					}
					this.addRoomType();

			})
		},
		addRoomType(){
		
			DB.callFunction(
							"hm_addRoomType",
							{
                                roomTypeObj:this.roomTypeForm
							}
						).then(async res=>{
                            console.log("添加成功");
                        await this.$store.dispatch("getRoomType");
                        this.$emit('closePopup');
						uni.hideLoading();
							
				}).catch(er => {
						console.log("添加失败",er);
						this.submitLoading = false;
						uni.hideLoading();
						uni.showModal({
							content:"系统异常，请稍候再试！",
							confirmText:"确认"
						});
					})
		},
		updateRoomType(){
			DB.callFunction(
							"hm_updateRoomType",
							{
								_id:this.rt._id,
                                roomTypeObj:this.roomTypeForm
							}
						).then(async res=>{
                            console.log("修改成功");
							await this.$store.dispatch("getRoomType");
                        this.$emit('closePopup');
						uni.hideLoading();
							
				}).catch(er => {
						console.log("修改失败",er);
						this.submitLoading = false;
						uni.hideLoading();
						uni.showModal({
							content:"系统异常，请稍候再试！",
							confirmText:"确认"
						});
					})
		},
		addRoomEvent(){
			let arr=this.roomTypeForm.roomList||[];			
			arr.push({index:arr.length+1,room_name:this.getRoomName(arr)})
		},
		deleteRoomEvent(index){
			console.log(index,this.roomTypeForm.roomList);
			 this.roomTypeForm.roomList.splice(index,1);
			
			//this.roomTypeForm.roomList=this.roomTypeForm.roomList.splice(index,1);
		},
		getRoomName(arr){
			let targetArr=[...arr];
			let newName = `房间${arr.length+1}`;
			let ob = arr.find(item=>item.room_name==newName);
			if(!ob){
				return newName;
			}else{
				targetArr.push("");
				return this.getRoomName(targetArr)
			}
			
		}
	}
}

</script>

<style lang="scss" scoped>
.room-area {
	.header {
		padding: 15px;
		display: flex;
		background: #f0f0f0;
		font-size: 13px;
		color: #565656;

		.btn {
			display: flex;
			color: #007aff;
		}
	}
}
.note{
	font-size: 12px;
	padding:15px;
	text-align: center;
	color: #a1a1a1;
}
.disabled-style {
	color: #a1a1a1;
}

.priceContainer {
	border: 1px solid #eee;
	padding: 8px;
	font-size: 14px;

	.price-list {
		.price-list-item {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;

			.group {
				min-width: 350px;
				display: flex;
				align-items: center;
			}

			.in {
				flex: 1;
				border: 1px solid #eee;
				padding: 4px 8px;
				font-size: 14px;
				color: #777777;
			}
		}
	}
}
</style>