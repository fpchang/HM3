<template>
	<view class="gather">
		<xt-panal-list :dataList="[{}]">

			<!-- #ifdef MP -->
			<view v-for="(item,index) of [{}]" slot="card{{index}}">
				<xt-subsection :items="['今天','明天']" @checkTab="changeGatgerTab"></xt-subsection>
				<view> 
					<uni-grid :column="3" :highlight="true" @change="change" :showBorder="false" v-if="GatgerTab_index==0">
						<uni-grid-item v-for="(it,ind) in showDataListToday" :index="index" :key="index">
							<view class=" flex-center" style="background-color: #fff;flex:1">
								<view style="padding:15px;display:flex;align-items:center;justify-content:center;flex-direction:column"> 
									<text style="font-weight:bold">{{it.numCount}}</text>
								<text style="color:#a1a1a1">{{it.title}}</text>
								</view>
								
							</view>
						</uni-grid-item>
					</uni-grid>
					<uni-grid :column="3" :highlight="true" @change="change" :showBorder="false" v-if="GatgerTab_index==1">
						<uni-grid-item v-for="(it,ind) in showDataListTommorow" :index="index" :key="index">
							<view class=" flex-center" style="background-color: #fff;flex:1">
								<view style="padding:15px;display:flex;align-items:center;justify-content:center;flex-direction:column"> 
									<text style="font-weight:bold">{{it.numCount}}</text>
								<text style="color:#a1a1a1">{{it.title}}</text>
								</view>
								
							</view>
						</uni-grid-item>
					</uni-grid>
					<!-- <uv-grid :border="true" v-if="GatgerTab_index==0">
						<uv-grid-item v-for="(it,ind) in showDataListToday">
							<view
								style="padding:15px;display:flex;align-items:center;justify-content:center;flex-direction:column">
								<text style="font-weight:bold">{{it.numCount}}</text>
								<text style="color:#a1a1a1">{{it.title}}</text>
							</view>
	
						</uv-grid-item>
					</uv-grid>
					<uv-grid :border="true" v-if="GatgerTab_index==1">
						<uv-grid-item v-for="(it,ind) in showDataListTommorow">
							<view
								style="padding:15px;display:flex;align-items:center;justify-content:center;flex-direction:column">
								<text style="font-weight:bold">{{it.numCount}}</text>
								<text style="color:#a1a1a1">{{it.title}}</text>
							</view>
	
						</uv-grid-item>
					</uv-grid> -->
				</view>
				
			</view>
			<!-- #endif -->
			<!-- #ifdef H5 || APP-PLUS -->
			<template v-for="(items,indexs) of [1]" v-slot:[`card${indexs}`]>

				<xt-subsection :items="['今天','明天']" @checkTab="changeGatgerTab"></xt-subsection>
				<view> 
					<uni-grid :column="3" :highlight="true" @change="change" :showBorder="false" v-if="GatgerTab_index==0">
						<uni-grid-item v-for="(it,ind) in showDataListToday" :index="index" :key="index">
							<view class=" flex-center" style="background-color: #fff;flex:1">
								<view style="padding:15px;display:flex;align-items:center;justify-content:center;flex-direction:column"> 
									<text style="font-weight:bold">{{it.numCount}}</text>
								<text style="color:#a1a1a1">{{it.title}}</text>
								</view>
								
							</view>
						</uni-grid-item>
					</uni-grid>
					<uni-grid :column="3" :highlight="true" @change="change" :showBorder="false" v-if="GatgerTab_index==1">
						<uni-grid-item v-for="(it,ind) in showDataListTommorow" :index="index" :key="index">
							<view class=" flex-center" style="background-color: #fff;flex:1">
								<view style="padding:15px;display:flex;align-items:center;justify-content:center;flex-direction:column"> 
									<text style="font-weight:bold">{{it.numCount}}</text>
								<text style="color:#a1a1a1">{{it.title}}</text>
								</view>
								
							</view>
						</uni-grid-item>
					</uni-grid>
			</view> 
			</template>
			<!-- #endif -->
		</xt-panal-list>
		<!-- <view style="display: flex; justify-content: center">
			<view class="card-container" :style="{width: `${cardContainerWidth}px`}">
				<view class="card" v-for="(item,index) of dataList" :style="{width:`${cardWidth}px`}">
					<view class="card-item">
						<gatherCardComponent :targetObj="item" :numCount="item.numCount">
							<template v-slot:content>
								<view>
									<uni-section class="mb-10" title="详情" type="line"></uni-section>
									<view v-if="index==0" class="c-list">
										<view class="c-list-item" v-for="it of item.list">
											<text>{{it.userName}}</text>
											<view>
												<text style="color: red;font-weight: bold;letter-spacing: 3px;">{{dayNum([it.checkInStartDateTimeStamp,it.checkInEndDateTimeStamp])}}</text><text>晚</text>
											</view>
										</view>
									</view>
									<view v-if="index==1" class="c-list">
										<view class="c-list-item" v-for="it of item.list">
											<text>{{it.userName}}</text>
											<view>
												<text
													style="color: red;font-weight: bold;letter-spacing: 3px;">{{roomNum(it)}}</text><text>间</text>
											</view>
										</view>
									</view>
									<view v-if="index==2" class="c-list">
										<view class="c-list-item" v-for="it of item.list">
											<text>{{it.userName}}</text>
											<view>
												<text
													style="color: red;font-weight: bold;">{{it.mealType=='lunch'?'午餐':'晚餐'}}</text>
											</view>
										</view>
									</view>
								</view>


							</template>
						</gatherCardComponent>
					</view>
				</view>

			</view>
		</view> -->
	</view>
</template>

<script>
	import gatherCardComponent from './gatherCardComponent.vue';
	import {
		OrderService
	} from '../../../services/OrderService';
	import {
		MenuService
	} from '../../../services/MenuService';
	import XtSubsection from '../../../components/xt-subsection/xt-subsection.vue';
	export default {
		components: {
			gatherCardComponent,
			XtSubsection
		},
		props: {

		},
		data() {
			return {
				testlist:[{}],
				widthTemp: 0,
				GatgerTab_index: 0,
				todayCheckInOrderList: [],
				chartList: [{
					title: "一个月内入住率",

					OrderList: []
				}, {
					title: "今年入住率",

					OrderList: []
				}],
				image: "",
				option: {}

			}
		},

		computed: {
			hotel_id() {
				return this.$store.state.hotel_id;
			},
			hotelList() {
				return this.$store.state.hotelList;
			},
			roomType() {
				return this.$store.state.roomType;
			},
			user() {
				return this.$store.state.user;
			},
			partialRefreshComName() {
				return this.$store.state.partialRefreshComName;
			},
			//今日办理入住的订单
			orderListByCheckInToday() {
				return this.$store.state.orderStore.orderListByCheckInToday;
			},
			//今日退房订单
			orderListByCheckOutToday() {
				return this.$store.state.orderStore.orderListByCheckOutToday;
			},
			//明日办理入住的订单
			orderListByCheckInTommorow() {
				return this.$store.state.orderStore.orderListByCheckInTommorow;
			},
			//明日退房订单
			orderListByCheckOutTommorow() {
				return this.$store.state.orderStore.orderListByCheckOutTommorow;
			},
			orderListByCheckInToday_format() {
				return {
					title: "今日办理入住",
					list: this.orderListByCheckInToday,
					numCount: this.orderListByCheckInToday.length
				}
			},
			//今日住客订单
			orderListToday() {
				return this.$store.state.orderStore.orderListToday;
			},
			//今日住客订单
			orderListTommorow() {
				return this.$store.state.orderStore.orderListTommorow;
			},
			orderListToday_format() {
				let numCount = 0;
				this.orderListToday.map(item => {
					let num = 0;
					item.roomTypeArray.map(it => {
						num += it.count;
					});
					numCount += num;
				})
				return {
					title: "今日入住房间数",
					list: this.orderListToday,
					numCount: numCount
				}
			},
			//今日餐饮订单
			orderDishesToday() {
				return this.$store.state.menuStore.orderDishesToday;
			},
			//明日餐饮订单
			orderDishesTommorow() {
				return this.$store.state.menuStore.orderDishesTommorow;
			},
			orderDishesToday_format() {
				return {
					title: "今日餐饮订单",
					list: this.orderDishesToday,
					numCount: this.orderDishesToday.length,
				}
			},
			dataList() {
				return [this.orderListByCheckInToday_format, this.orderListToday_format, this.orderDishesToday_format]
			},
			isPc() {
				try {
					return (
						uni.getSystemInfoSync().deviceType == "pc" ||
						uni.getDeviceInfo().deviceType == "pc"
					);
				} catch (e) {
					return false;
				}
			},
			viewWidth() {
				// let viewWidth = uni.getWindowInfo().windowWidth || uni.getWindowInfo().screenWidth;
				// let scrollWidth = this.isPc ? 20 : 0;
				// return viewWidth + this.widthTemp - this.widthTemp - scrollWidth;
				return this.$store.state.viewWidth + this.widthTemp - this.widthTemp;
			},

			cardWidth() {
				let windowWidth = this.viewWidth; //-20 为pc端滚动条宽度
				let count = Math.floor(windowWidth / 320);
				if (count == 0) {
					return windowWidth;
				}
				let ys = windowWidth % 320
				return Math.min(320 + (ys / count), 450)
			},
			cardContainerWidth() {
				let count = Math.max(Math.floor(this.viewWidth / this.cardWidth), 1);
				return this.cardWidth * count
			},
			isPcShow() {
				return this.$store.state.isPcShow;
			},
			roomTypeCount() {
				let count = 0;
				this.roomType.map(item => {
					count += item.count;
				})
				return count;
			},
			//今日信息
			showDataListToday() {
				const c1 = this.getRoomCountFromOrderList(this.orderListByCheckInToday);
				const c2 = this.getRoomCountFromOrderList(this.orderListByCheckOutToday);
				const c3 = this.getRoomCountFromOrderList(this.orderListToday);
				return [{
					numCount: c1,
					title: '入住'
				}, {
					numCount: c2,
					title: '退房'
				}, {
					numCount: c3,
					title: '在住'
				}, {
					numCount:Math.max( this.roomTypeCount - c3,0),
					title: '空房'
				}, {
					numCount: this.orderDishesToday.length,
					title: '餐单'
				}]
			},
			//明日信息
			showDataListTommorow() {
				const c1 = this.getRoomCountFromOrderList(this.orderListByCheckInTommorow);
				const c2 = this.getRoomCountFromOrderList(this.orderListByCheckOutTommorow);
				const c3 = this.getRoomCountFromOrderList(this.orderListTommorow);
				return [{
					numCount: c1,
					title: '入住'
				}, {
					numCount: c2,
					title: '退房'
				}, {
					numCount: c3,
					title: '在住'
				}, {
					numCount:Math.max( this.roomTypeCount - c3,0),
					title: '空房'
				}, {
					numCount: this.orderDishesTommorow.length,
					title: '餐单'
				}]
			}

		},
		watch: {
			async partialRefreshComName(val) {
				//下拉刷新
				if (val == 'gatherComponent') {
					console.log("局部刷新 gather")
					await this.$store.dispatch("getGatherEvent", this.hotel_id);
					await this.$store.dispatch("getMenuEvent",this.hotel_id);
					this.$store.commit("setPartialRefreshComName", "");
					console.log("局部刷新完成")
					uni.hideLoading();
					uni.stopPullDownRefresh();
				}
			},
			hotel_id() {
				this.initData();
			}
		},

		mounted() {

			this.option = {
				grid: {
					right: 20
				},
				xAxis: {
					type: 'category',
					data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
				},
				yAxis: {
					type: 'value'
				},
				series: [{
					data: [150, 230, 224, 218, 135, 147, 260],
					type: 'line'
				}]
			}
			this.initData();
		},
		onLoad: function() {
			console.log('gatherComponent Show')
		},
		created() {
			console.log("gathercomponent created;;;;");

		},

		methods: {
			changeGatgerTab(index) {
				this.GatgerTab_index = index;
			},
			async initData() {
				console.log("init data gather")
				this.$store.dispatch("getGatherEvent", this.hotel_id);
				this.$store.dispatch("getMenuEvent",this.hotel_id);


			},
			dayNum(params) {
				return Math.ceil((params[1] - params[0]) / (1000 * 60 * 60 * 24))
			},
			//今日客房数量
			roomNum(it) {
				let num = 0;
				it.roomTypeArray.map(item => {
					num += item.count;
				})
				return num
			},
			//订单列表中计算有多少房间
			getRoomCountFromOrderList(orderList) {
				let numCount = 0;
				orderList.map(item => {
					let num = 0;
					item.roomTypeArray.map(it => {
						num += it.count;
					});
					numCount += num;
				})
				return numCount;
			}

		}
	}
</script>

<style lang="scss" scoped>
	.gather {}

	.card-container {
		display: flex;
		flex-wrap: wrap;
		min-width: 320px;

		.card {
			min-width: 320px;
			max-width: 450px;
			padding: 10px;
			box-sizing: border-box;

			.card-item {
				height: 100%;
				box-sizing: border-box;
				background: #fff;
				padding: 10px 20px;
				box-shadow: 0 0 4px 4px #e4e0e0;
				border-radius: 8px;

			}
		}
	}

	.c-list {
		.c-list-item {
			display: flex;
			justify-content: space-between;
			padding: 8px 10px;
			font-size: 13px;

		}
	}
</style>